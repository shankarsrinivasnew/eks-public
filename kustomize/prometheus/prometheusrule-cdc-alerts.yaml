apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    app: kube-prometheus-stack
    release: prometheus
  name: cdc-down-alerts
  namespace: prometheus
spec:
  groups:
  - name: CDC_Alerts
      
    rules:
    - record: datastore_state
      expr: (datastore_state)

    - alert: CDC_Subscription_State
      expr: datastore_state < 1
      for: 1m
      labels:
        environment: "{{ AWS_ENVIRONMENT }}"
        level: CRITICAL
        platform: AWS
        severity: CRITICAL
        priority: P3
        application: cdc
        tsbci: INFOSPHERE_CDC
        itopsbridge: "true"
      annotations:
        Description: '***State of {{ $labels.subscription }} is not Mirror Continuous. State:{{ $labels.state }} and Status:{{ $labels.status }}'
        Summary: Alert CDC- State of {{ $labels.subscription }} is not Mirror Continuous

    - alert: CDC_Subscription_Availability
      expr: count(datastore_state) < 2
      for: 1m
      labels:
        environment: "{{ AWS_ENVIRONMENT }}"
        level: CRITICAL
        platform: AWS
        severity: CRITICAL
        priority: P3
        application: cdc
        tsbci: INFOSPHERE_CDC
        itopsbridge: "true"
      annotations:
        Description: '***One or more subscriptions is/are not available. Value: {{ $value }} Value:1 means one subcription is missing, Value:0 means all 2 subscriptions are missing'
        Summary: Alert CDC- One or more subscriptions is/are not available
        
    - alert: CDC_ProcessNearFDLimits
      expr: process_open_fds > 4096
      for: 15m
      labels: 
        environment: "{{ AWS_ENVIRONMENT }}"
        level: CRITICAL
        platform: AWS
        severity: CRITICAL
        priority: P3
        application: cdc
        tsbci: INFOSPHERE_CDC
        itopsbridge: "true"
      annotations:  
        Description: 'File decriptors for CDC is server greater than 4096'
        summary: 'File decriptors for Instance {{ $labels.instance }} is greater than 4096'
