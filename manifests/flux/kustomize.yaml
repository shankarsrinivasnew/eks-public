---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kustomize-plugins
  namespace: flux
data:
  AWSTransformer: |
    #!/bin/bash

    # Ignore script name
    shift

    # Get AWS properties
    AWS_ACCOUNT=$(wget -O - -Y off http://169.254.169.254/latest/dynamic/instance-identity/document | sed -nE 's/.*"accountId"\s*:\s*"(.*)".*/\1/p')
    DNS_ZONE=dev.aws.uk.tsb
    IAM_ADMIN_ROLE_NAME=tsb-aws-administrator
    GIT_BRANCH=dev
    CLUSTER_NAME=dev-eks
    VPC=10.161.64.0/18 
    ACCESS_SUBNET_A=10.161.64.0/23
    ACCESS_SUBNET_B=10.161.66.0/23
    ACCESS_SUBNET_C=10.161.68.0/23
    DATA_SUBNET_A=10.161.72.0/23
    DATA_SUBNET_B=10.161.74.0/23
    DATA_SUBNET_C=10.161.76.0/23
    CORE_SUBNET_A=10.161.80.0/20
    CORE_SUBNET_B=10.161.96.0/20
    CORE_SUBNET_C=10.161.112.0/20
    DNS=10.161.64.2

    case $AWS_ACCOUNT in
      273312704578)
        DNS_ZONE=nonprod.aws.uk.tsb
        IAM_ADMIN_ROLE_NAME=rl_tsbsme_non_prod_admin
        GIT_BRANCH=nonprod
        CLUSTER_NAME=nonprod-eks
        VPC=10.161.128.0/17
        ACCESS_SUBNET_A=10.161.128.0/22
        ACCESS_SUBNET_B=10.161.132.0/22
        ACCESS_SUBNET_C=10.161.136.0/22
        DATA_SUBNET_A=10.161.144.0/22
        DATA_SUBNET_B=10.161.148.0/22
        DATA_SUBNET_C=10.161.152.0/22
        CORE_SUBNET_A=10.161.160.0/19
        CORE_SUBNET_B=10.161.192.0/19
        CORE_SUBNET_C=10.161.224.0/19
        DNS=10.161.128.2
        ;;
      045223552195)
        DNS_ZONE=preprod.aws.uk.tsb
        IAM_ADMIN_ROLE_NAME=rl_tsbsme_staging_admin
        GIT_BRANCH=preprod
        CLUSTER_NAME=preprod-eks
        VPC=10.162.128.0/17
        ACCESS_SUBNET_A=10.162.128.0/22
        ACCESS_SUBNET_B=10.162.132.0/22
        ACCESS_SUBNET_C=10.162.136.0/22
        DATA_SUBNET_A=10.162.144.0/22
        DATA_SUBNET_B=10.162.148.0/22
        DATA_SUBNET_C=10.162.152.0/22
        CORE_SUBNET_A=10.162.160.0/19
        CORE_SUBNET_B=10.162.192.0/19
        CORE_SUBNET_C=10.162.224.0/19
        DNS=10.162.128.2
        ;;
      407929326957)
        DNS_ZONE=prod.aws.uk.tsb
        IAM_ADMIN_ROLE_NAME=rl_tsbsme_prod_admin
        GIT_BRANCH=master
        CLUSTER_NAME=prod-eks
        VPC=10.163.128.0/17
        ACCESS_SUBNET_A=10.163.128.0/22
        ACCESS_SUBNET_B=10.163.132.0/22
        ACCESS_SUBNET_C=10.163.136.0/22
        DATA_SUBNET_A=10.163.144.0/22
        DATA_SUBNET_B=10.163.148.0/22
        DATA_SUBNET_C=10.163.152.0/22
        CORE_SUBNET_A=10.163.160.0/19
        CORE_SUBNET_B=10.163.192.0/19
        CORE_SUBNET_C=10.163.224.0/19
        DNS=10.163.128.2
        ;;
    esac

    # Update manifest
    sed "s/{{ AWS_ACCOUNT }}/$AWS_ACCOUNT/g;s/{{ DNS_ZONE }}/$DNS_ZONE/g;s/{{ IAM_ADMIN_ROLE_NAME }}/$IAM_ADMIN_ROLE_NAME/g;s/{{ GIT_BRANCH }}/$GIT_BRANCH/g;s/{{ CLUSTER_NAME }}/$CLUSTER_NAME/g;s/{{ VPC }}/$VPC/g;s/{{ ACCESS_SUBNET_A }}/$ACCESS_SUBNET_A/g;s/{{ ACCESS_SUBNET_B }}/$ACCESS_SUBNET_B/g;s/{{ ACCESS_SUBNET_C }}/$ACCESS_SUBNET_C/g;s/{{ DATA_SUBNET_A }}/$DATA_SUBNET_A/g;s/{{ DATA_SUBNET_B }}/$DATA_SUBNET_B/g;s/{{ DATA_SUBNET_C }}/$DATA_SUBNET_C/g;s/{{ CORE_SUBNET_A }}/$CORE_SUBNET_A/g;s/{{ CORE_SUBNET_B }}/$CORE_SUBNET_B/g;s/{{ CORE_SUBNET_C }}/$CORE_SUBNET_C/g;s/{{ DNS }}/$DNS/g" $1