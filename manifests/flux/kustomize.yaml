---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kustomize-plugins
  namespace: flux
data:
  v1/AWSTransformer/AWSTransformer.yaml: |
    #!/bin/bash

    # Ignore script name
    shift

    # Get AWS properties
    AWS_ACCOUNT=$(wget -O - http://169.254.169.254/latest/dynamic/instance-identity/document | sed -nE 's/.*"accountId"\s*:\s*"(.*)".*/\1/p')

    # Update manifest
    sed "s/{{ AWS_ACCOUNT }}/$AWS_ACCOUNT/g" $1